/*
* SplitterSegmentExtractorTest.cpp
* Tests the splitter segment extractor.
*
Copyright 2018 Michal Gallus

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
#define GTEST_LANG_CXX11 1

#include <gtest/gtest.h>
#include "Spectre.libGaussianMixtureModelling/SplitterSegmentExtractor.h"
#include "Spectre.libGaussianMixtureModelling/SplitterSegmentExtractorPar.h"

namespace spectre::unsupervised::gmm
{
class SplitterSegmentExtractorTest : public ::testing::Test
{
public:
    SplitterSegmentExtractorTest()
    {
        signal.mzs = {
            2000.00000000000, 2000.80008000800, 2001.60016001600, 2002.40024002400,
            2003.20032003200, 2004.00040004000, 2004.80048004800, 2005.60056005601,
            2006.40064006401, 2007.20072007201, 2008.00080008001, 2008.80088008801,
            2009.60096009601, 2010.40104010401, 2011.20112011201, 2012.00120012001,
            2012.80128012801, 2013.60136013601, 2014.40144014401, 2015.20152015202,
            2016.00160016002, 2016.80168016802, 2017.60176017602, 2018.40184018402,
            2019.20192019202, 2020.00200020002, 2020.80208020802, 2021.60216021602,
            2022.40224022402, 2023.20232023202, 2024.00240024002, 2024.80248024802,
            2025.60256025603, 2026.40264026403, 2027.20272027203, 2028.00280028003,
            2028.80288028803, 2029.60296029603, 2030.40304030403, 2031.20312031203,
            2032.00320032003, 2032.80328032803, 2033.60336033603, 2034.40344034403,
            2035.20352035204, 2036.00360036004, 2036.80368036804, 2037.60376037604,
            2038.40384038404, 2039.20392039204, 2040.00400040004, 2040.80408040804,
            2041.60416041604, 2042.40424042404, 2043.20432043204, 2044.00440044004,
            2044.80448044804, 2045.60456045605, 2046.40464046405, 2047.20472047205,
            2048.00480048005, 2048.80488048805, 2049.60496049605, 2050.40504050405,
            2051.20512051205, 2052.00520052005, 2052.80528052805, 2053.60536053605,
            2054.40544054405, 2055.20552055206, 2056.00560056006, 2056.80568056806,
            2057.60576057606, 2058.40584058406, 2059.20592059206, 2060.00600060006,
            2060.80608060806, 2061.60616061606, 2062.40624062406, 2063.20632063206,
            2064.00640064006, 2064.80648064806, 2065.60656065607, 2066.40664066407,
            2067.20672067207, 2068.00680068007, 2068.80688068807, 2069.60696069607,
            2070.40704070407, 2071.20712071207, 2072.00720072007, 2072.80728072807,
            2073.60736073607, 2074.40744074407, 2075.20752075208, 2076.00760076008,
            2076.80768076808, 2077.60776077608, 2078.40784078408, 2079.20792079208,
            2080.00800080008, 2080.80808080808, 2081.60816081608, 2082.40824082408,
            2083.20832083208, 2084.00840084008, 2084.80848084809, 2085.60856085609,
            2086.40864086409, 2087.20872087209, 2088.00880088009, 2088.80888088809,
            2089.60896089609, 2090.40904090409, 2091.20912091209, 2092.00920092009,
            2092.80928092809, 2093.60936093609, 2094.40944094409, 2095.20952095210,
            2096.00960096010, 2096.80968096810, 2097.60976097610, 2098.40984098410,
            2099.20992099210, 2100.01000100010, 2100.81008100810, 2101.61016101610,
            2102.41024102410, 2103.21032103210, 2104.01040104010, 2104.81048104811,
            2105.61056105611, 2106.41064106411, 2107.21072107211, 2108.01080108011,
            2108.81088108811, 2109.61096109611, 2110.41104110411, 2111.21112111211,
            2112.01120112011, 2112.81128112811, 2113.61136113611, 2114.41144114411,
            2115.21152115212, 2116.01160116012, 2116.81168116812, 2117.61176117612,
            2118.41184118412, 2119.21192119212, 2120.01200120012, 2120.81208120812,
            2121.61216121612, 2122.41224122412, 2123.21232123212, 2124.01240124012,
            2124.81248124812, 2125.61256125613, 2126.41264126413, 2127.21272127213,
            2128.01280128013, 2128.81288128813, 2129.61296129613, 2130.41304130413,
            2131.21312131213, 2132.01320132013, 2132.81328132813, 2133.61336133613,
            2134.41344134413, 2135.21352135214, 2136.01360136014, 2136.81368136814,
            2137.61376137614, 2138.41384138414, 2139.21392139214, 2140.01400140014,
            2140.81408140814, 2141.61416141614, 2142.41424142414, 2143.21432143214,
            2144.01440144014, 2144.81448144814, 2145.61456145615, 2146.41464146415,
            2147.21472147215, 2148.01480148015, 2148.81488148815, 2149.61496149615,
            2150.41504150415, 2151.21512151215, 2152.01520152015, 2152.81528152815,
            2153.61536153615, 2154.41544154415, 2155.21552155216, 2156.01560156016,
            2156.81568156816, 2157.61576157616, 2158.41584158416, 2159.21592159216,
            2160.01600160016, 2160.81608160816, 2161.61616161616, 2162.41624162416,
            2163.21632163216, 2164.01640164016, 2164.81648164817, 2165.61656165617,
            2166.41664166417, 2167.21672167217, 2168.01680168017, 2168.81688168817,
            2169.61696169617, 2170.41704170417, 2171.21712171217, 2172.01720172017,
            2172.81728172817, 2173.61736173617, 2174.41744174417, 2175.21752175218,
            2176.01760176018, 2176.81768176818, 2177.61776177618, 2178.41784178418,
            2179.21792179218, 2180.01800180018, 2180.81808180818, 2181.61816181618,
            2182.41824182418, 2183.21832183218, 2184.01840184018, 2184.81848184819,
            2185.61856185619, 2186.41864186419, 2187.21872187219, 2188.01880188019,
            2188.81888188819, 2189.61896189619, 2190.41904190419, 2191.21912191219,
            2192.01920192019, 2192.81928192819, 2193.61936193619, 2194.41944194419,
            2195.21952195220, 2196.01960196020, 2196.81968196820, 2197.61976197620,
            2198.41984198420, 2199.21992199220, 2200.02000200020, 2200.82008200820,
            2201.62016201620, 2202.42024202420, 2203.22032203220, 2204.02040204020,
            2204.82048204820, 2205.62056205621, 2206.42064206421, 2207.22072207221,
            2208.02080208021, 2208.82088208821, 2209.62096209621, 2210.42104210421,
            2211.22112211221, 2212.02120212021, 2212.82128212821, 2213.62136213621,
            2214.42144214421, 2215.22152215222, 2216.02160216022, 2216.82168216822,
            2217.62176217622, 2218.42184218422, 2219.22192219222, 2220.02200220022,
            2220.82208220822, 2221.62216221622, 2222.42224222422, 2223.22232223222,
            2224.02240224022, 2224.82248224823, 2225.62256225623, 2226.42264226423,
            2227.22272227223, 2228.02280228023, 2228.82288228823, 2229.62296229623,
            2230.42304230423, 2231.22312231223, 2232.02320232023, 2232.82328232823,
            2233.62336233623, 2234.42344234423, 2235.22352235224, 2236.02360236024,
            2236.82368236824, 2237.62376237624, 2238.42384238424, 2239.22392239224,
            2240.02400240024, 2240.82408240824, 2241.62416241624, 2242.42424242424,
            2243.22432243224
        };

        signal.intensities = {
            0.000000000000000, 0.000000000000000, 0.000000000000000, 0.000000000000000,
            0.000000000000000, 0.00313896763865884, 0.471441652934461, 0.672030678788723,
            0.816262002801366, 1.08915090226750, 0.908525574332631, 1.09942659964331,
            1.00831471686859, 0.898924784053919, 0.830397142089201, 0.921254469136256,
            0.809914526511511, 0.495504714920023, 1.05933645531290, 0.715764166159622,
            0.654187646945404, 0.833199942407827, 0.472595554612829, 0.718948317424693,
            0.202560913964748, 0.512811386708187, 0.153311309685319, 0.793625363077548,
            0.435753748045594, 0.394305054377424, 0.535609833834569, 0.240742736542648,
            0.387432851938412, 0.581676305935098, 0.251998227512921, 0.437725964408568,
            0.299204203319242, 0.386115747151888, 0.0515198664285381, 0.444600759614117,
            0.0639361145978792, 0.342632162977885, 0.276130057228110, 0.207216215629398,
            0.159000891995082, 0.340759880325978, 0.340907819950338, 0.0752842833854910,
            0.347991930113223, 0.0655464814652516, 0.0535377938634696, 0.128621425265965,
            0.00440900747876283, 0.547525466603544, 0.0462087396643245, 0.206736722218696,
            0.298919157730883, 0.351887452803929, 0.221942250929720, 0.0498827295799202,
            0.322057711010452, 0.161881211035329, 0.446876732255314, 0.182970463954745,
            0.153766118805060, 0.000000000000000, 0.287548761839049, 0.512123839022823,
            0.186824480511958, 0.179939042464079, 0.000000000000000, 0.136815906257107,
            0.185978281818155, 0.000000000000000, 0.484017412267977, 0.339418339719114,
            0.531544946658384, 0.688042523875261, 1.34163313658041, 1.41343838963380,
            2.56441964254438, 3.48553707573873, 4.77091832781994, 6.67204533882371,
            8.03991968146468, 9.98593853528940, 11.3240442419170, 12.5613998608927,
            13.7376502011761, 13.4248779885916, 12.6472694717968, 11.5196552268043,
            10.5285850658990, 8.41731591419851, 6.47564575313087, 5.58747738339363,
            4.04115299837117, 2.79329356694543, 1.83514133765118, 1.11597252660942,
            0.766239641113877, 0.513732841123777, 0.346710783640829, 0.453926288540250,
            0.000000000000000, 0.298585462364539, 0.188908177104015, 0.000000000000000,
            0.380566263007272, 0.207680789399876, 0.110507439129649, 0.0832567555737356,
            0.165409332028748, 0.185605135114612, 0.219507662840845, 0.380311951491821,
            0.154004273557106, 0.378592237262633, 0.0589452781682507, 0.000000000000000,
            0.283578960805238, 0.243027948124485, 0.153480502037719, 0.231274299584042,
            0.565708003178639, 0.0845741327545553, 0.363814250712118, 0.530574138576480,
            0.450242351634906, 0.278465187341858, 0.360944309566526, 0.536542189711439,
            0.557343781971436, 0.261807240564701, 0.359553640289308, 0.00295847497307244,
            0.443706843804907, 0.436934799504090, 0.214428108181404, 0.469840546122176,
            0.183786549444292, 0.356344468117616, 0.498398033291890, 0.579800528843963,
            0.235528580139978, 0.425006089807245, 0.418877168608038, 0.586111885878723,
            0.421885698327960, 0.393189119330898, 0.153915392227581, 0.289274069495940,
            0.633389783852282, 0.334325185622669, 0.714250658695391, 0.373174236965407,
            0.549606704736641, 0.568763807499102, 0.528982577133316, 0.215236083423240,
            0.509255983624142, 0.313185342444855, 0.657083190191125, 0.481111033017786,
            0.230366801502450, 0.793712451251984, 0.604310478317509, 0.275698055496782,
            0.833571126992267, 0.404651161912478, 0.474211011821594, 0.512414016524425,
            0.434053811340302, 0.694180243213424, 0.628647911765159, 0.476179942834389,
            0.269951308147264, 0.426418137132319, 0.301456816413510, 0.520458522853752,
            0.440846526768305, 0.456439612095708, 0.455179491074684, 0.513236419097895,
            0.515741955447879, 0.376053200545569, 0.235858777787196, 0.878625776015537,
            0.361285406151753, 0.511426112346159, 0.0976358390677712, 0.487442029178184,
            0.472710043762935, 0.600920541597815, 0.494144789702100, 0.229277018204003,
            0.278545152253129, 0.331778027778054, 0.386725619772055, 0.397401507822554,
            0.274924844281347, 0.502904731071679, 0.548361788492896, 0.749320032582061,
            0.850872576261417, 1.28708518242974, 1.31550784822034, 1.82727389365701,
            2.44858664173529, 2.78032398633831, 4.24851166333781, 5.28667967857275,
            6.61248438056384, 7.55880264777807, 8.95384776440258, 9.78130521847610,
            10.3225815604355, 10.0255291682811, 8.89254971708995, 7.69004784060688,
            6.40751494646264, 5.13456492698703, 3.60509100193144, 2.78414228847203,
            2.02153221957529, 1.32282513138409, 0.902639040231044, 0.472400437658552
            , 0.370300174663148, 0.274423775317556, 0.0500022864185772, 0.248729924519168,
            0.000000000000000, 0.0742830491287789, 0.183247113604797, 0.000000000000000,
            0.264531948108303, 0.000000000000000, 0.229133105123512, 0.123872861906422,
            0.000000000000000, 0.000000000000000, 0.110332008830386, 0.000000000000000,
            0.437734094645375, 0.0383989079033633, 0.0688598159638985, 0.000000000000000,
            0.139642505194912, 0.152766542675404, 0.216602740680973, 0.000000000000000,
            0.000000000000000, 0.0109220433973314, 0.289934877315602, 0.0612025622795123,
            0.0881055791916359, 0.282267917872234, 0.000000000000000, 0.455546499813490,
            0.272441096699381, 0.860595358207989, 0.782394599354565, 1.624750244336380,
            1.842978853070220, 3.006734867871080, 4.435337156654040, 5.983774260510300,
            8.000950143260260, 10.61528251475680, 13.36417509020870, 15.57454908400850,
            18.36476867291630, 21.36152055445980, 22.06570684143910, 23.03211657204620,
            23.09990489887500, 22.29194787057380, 20.80461593917780, 18.57750196463410,
            15.50765765983910, 13.99864501634680, 12.19151324017830, 9.012084528482860,
            7.892239948084030, 6.407075617962490, 4.991850327989570, 3.930038447315680,
            2.546998481418040, 2.016120002696460, 1.133895525996300, 1.042415291653160,
            0.803522398623144, 0.304487965114115, 0.415321925886313, 0.381478154663490,
            0.283395520133245, 0.532117970960521, 0.0241553342805583, 0.330850904436683,
            0.197372802506284, 0.194093687609676, 0.617869601781809, 0.000000000000000,
            0.317124777538457
        };

        valleyIndices = {
            1, 53, 66, 105, 108, 120, 136, 191, 233, 233, 241, 299, 304, 322
        };

        peaks.mzs = {
            2012.00120012001, 2048.00480048005, 2071.20712071207, 2084.00840084008,
            2090.40904090409, 2105.61056105611, 2133.61336133613, 2172.81728172817,
            2185.61856185619, 2191.21912191219, 2220.02200220022, 2241.62416241624,
            2256.02560256026, 2264.02640264026, 2300.03000300030
        };

        peaks.intensities = {
            0.641001416694329, 0.293098455682601, 12.4017115410172, 0.305564793155960,
            0.362273207279340, 0.549642773004208, 0.754567144055570, 9.28598864810695,
            0.375676907304468, 0.358776012801994, 22.3854253219402, 0.402756491002316,
            0.429546547626444, 0.320665320914516, 131.956108781198
        };
    }

    template<typename T>
    void TestExtraction()
    {
        T extractor;
        constexpr DataType MAX_ERROR = 0.0001;
        constexpr Index SPLITTING_PEAK_INDEX = 8;
        constexpr DataType RESOLUTION_COEFF = 0.00214166770575118;
        Spectrum splitterSegment = extractor.ExtractSplitterSegment(peaks, signal,
            valleyIndices, SPLITTING_PEAK_INDEX, RESOLUTION_COEFF);

        EXPECT_NEAR(2056.439080921610, splitterSegment.mzs[0], MAX_ERROR);
        EXPECT_NEAR(2083.208320832080, splitterSegment.mzs[33], MAX_ERROR);
        EXPECT_NEAR(2084.008400840080, splitterSegment.mzs[34], MAX_ERROR);
        EXPECT_NEAR(2241.624162416240, splitterSegment.mzs[231], MAX_ERROR);
        EXPECT_NEAR(2242.424242424240, splitterSegment.mzs[232], MAX_ERROR);
        EXPECT_NEAR(2271.227122712270, splitterSegment.mzs[268], MAX_ERROR);

        EXPECT_NEAR(0.000000000000000, splitterSegment.intensities[0], MAX_ERROR);
        EXPECT_NEAR(0.000000000000000, splitterSegment.intensities[33], MAX_ERROR);
        EXPECT_NEAR(0.298585462364539, splitterSegment.intensities[34], MAX_ERROR);
        EXPECT_NEAR(0.617869601781809, splitterSegment.intensities[231], MAX_ERROR);
        EXPECT_NEAR(0.000000000000000, splitterSegment.intensities[232], MAX_ERROR);
        EXPECT_NEAR(0.000000000000000, splitterSegment.intensities[268], MAX_ERROR);
    }

protected:
    
    Spectrum signal;
    Indices valleyIndices;
    Peaks peaks;
};

TEST_F(SplitterSegmentExtractorTest, check_if_properly_extracts_splitter_segment)
{
    TestExtraction<SplitterSegmentExtractor>();
}

TEST_F(SplitterSegmentExtractorTest, check_if_properly_extracts_splitter_segment_par)
{
    TestExtraction<SplitterSegmentExtractorPar>();
}
}
