/*
* EmergencyCorrectionTest.cpp
* Tests the functionality of overlapping splitter correction.
*
Copyright 2018 Michal Gallus

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
#define GTEST_LANG_CXX11 1

#include <gtest/gtest.h>
#include "Spectre.libGaussianMixtureModelling/EmergencyCorrection.h"

namespace spectre::unsupervised::gmm
{
class EmergencyCorrectionTest : public ::testing::Test
{
public:
    EmergencyCorrectionTest()
    {
        data.mzs = { 0.0, 2.0, 4.0, 6.0, 8.0 };
        data.intensities = { 0.0, 2.0, 6.0, 2.0, 0.0 };
        model.push_back({ 4.0, 0.5, 1.0 });
    }

protected:
    Spectrum data;
    GaussianMixtureModel model;
    static constexpr DataType MAX_ERROR = 0.5;
};

TEST_F(EmergencyCorrectionTest, correctly_corrects_uncorrected_overlap)
{
    constexpr Index segmentIndex = 1;
    const GmmOptions options;
    Spectrum spectrum;
    spectrum.mzs = {
        6123.61236123612, 6124.41244124412, 6125.21252125213, 6126.01260126013,
        6126.81268126813, 6127.61276127613, 6128.41284128413, 6129.21292129213,
        6130.01300130013, 6130.81308130813, 6131.61316131613, 6132.41324132413,
        6133.21332133213, 6134.01340134013, 6134.81348134814, 6135.61356135614,
        6136.41364136414, 6137.21372137214, 6138.01380138014, 6138.81388138814,
        6139.61396139614, 6140.41404140414, 6141.21412141214, 6142.01420142014,
        6142.81428142814, 6143.61436143614, 6144.41444144414, 6145.21452145215,
        6146.01460146015, 6146.81468146815, 6147.61476147615, 6148.41484148415,
        6149.21492149215, 6150.01500150015, 6150.81508150815, 6151.61516151615,
        6152.41524152415, 6153.21532153215, 6154.01540154015, 6154.81548154816,
        6155.61556155616, 6156.41564156416, 6157.21572157216, 6158.01580158016,
        6158.81588158816, 6159.61596159616, 6160.41604160416, 6161.21612161216,
        6162.01620162016, 6162.81628162816, 6163.61636163616, 6164.41644164416,
        6165.21652165217, 6166.01660166017, 6166.81668166817, 6167.61676167617,
        6168.41684168417, 6169.21692169217, 6170.01700170017, 6170.81708170817,
        6171.61716171617, 6172.41724172417, 6173.21732173217, 6174.01740174017,
        6174.81748174818, 6175.61756175618, 6176.41764176418, 6177.21772177218,
        6178.01780178018, 6178.81788178818, 6179.61796179618, 6180.41804180418,
        6181.21812181218, 6182.01820182018, 6182.81828182818, 6183.61836183618,
        6184.41844184419, 6185.21852185219, 6186.01860186019, 6186.81868186819,
        6187.61876187619, 6188.41884188419, 6189.21892189219, 6190.01900190019,
        6190.81908190819, 6191.61916191619, 6192.41924192419, 6193.21932193219,
        6194.01940194019, 6194.81948194820, 6195.61956195620, 6196.41964196420,
        6197.21972197220, 6198.01980198020, 6198.81988198820, 6199.61996199620,
        6200.42004200420, 6201.22012201220, 6202.02020202020, 6202.82028202820,
        6203.62036203620, 6204.42044204421, 6205.22052205221, 6206.02060206021,
        6206.82068206821, 6207.62076207621, 6208.42084208421, 6209.22092209221,
        6210.02100210021, 6210.82108210821, 6211.62116211621, 6212.42124212421,
        6213.22132213221, 6214.02140214021, 6214.82148214822, 6215.62156215622,
        6216.42164216422, 6217.22172217222, 6218.02180218022, 6218.82188218822,
        6219.62196219622, 6220.42204220422, 6221.22212221222, 6222.02220222022,
        6222.82228222822, 6223.62236223622, 6224.42244224423, 6225.22252225223,
        6226.02260226023, 6226.82268226823, 6227.62276227623, 6228.42284228423,
        6229.22292229223, 6230.02300230023, 6230.82308230823, 6231.62316231623,
        6232.42324232423, 6233.22332233223, 6234.02340234023, 6234.82348234823,
        6235.62356235624, 6236.42364236424, 6237.22372237224, 6238.02380238024,
        6238.82388238824, 6239.62396239624, 6240.42404240424, 6241.22412241224,
        6242.02420242024, 6242.82428242824, 6243.62436243624, 6244.42444244424,
        6245.22452245225, 6246.02460246025, 6246.82468246825, 6247.62476247625,
        6248.42484248425, 6249.22492249225, 6250.02500250025, 6250.82508250825,
        6251.62516251625, 6252.42524252425, 6253.22532253225, 6254.02540254025,
        6254.82548254825, 6255.62556255626, 6256.42564256426, 6257.22572257226,
        6258.02580258026, 6258.82588258826, 6259.62596259626, 6260.42604260426,
        6261.22612261226, 6262.02620262026, 6262.82628262826, 6263.62636263626,
        6264.42644264426, 6265.22652265227, 6266.02660266027, 6266.82668266827,
        6267.62676267627, 6268.42684268427, 6269.22692269227, 6270.02700270027,
        6270.82708270827, 6271.62716271627, 6272.42724272427, 6273.22732273227,
        6274.02740274027, 6274.82748274828, 6275.62756275628, 6276.42764276428,
        6277.22772277228, 6278.02780278028, 6278.82788278828, 6279.62796279628,
        6280.42804280428, 6281.22812281228, 6282.02820282028, 6282.82828282828,
        6283.62836283628, 6284.42844284428, 6285.22852285229, 6286.02860286029,
        6286.82868286829, 6287.62876287629, 6288.42884288429, 6289.22892289229,
        6290.02900290029, 6290.82908290829, 6291.62916291629, 6292.42924292429,
        6293.22932293229, 6294.02940294029, 6294.82948294830, 6295.62956295630,
        6296.42964296430, 6297.22972297230, 6298.02980298030, 6298.82988298830,
        6299.62996299630, 6300.43004300430, 6301.23012301230, 6302.03020302030,
        6302.83028302830, 6303.63036303630, 6304.43044304430, 6305.23052305231,
        6306.03060306031, 6306.83068306831, 6307.63076307631, 6308.43084308431,
        6309.23092309231, 6310.03100310031, 6310.83108310831, 6311.63116311631,
        6312.43124312431, 6313.23132313231, 6314.03140314031, 6314.83148314832,
        6315.63156315632, 6316.43164316432, 6317.23172317232, 6318.03180318032,
        6318.83188318832, 6319.63196319632, 6320.43204320432, 6321.23212321232,
        6322.03220322032, 6322.83228322832, 6323.63236323632, 6324.43244324432,
        6325.23252325233, 6326.03260326033, 6326.83268326833, 6327.63276327633,
        6328.43284328433, 6329.23292329233, 6330.03300330033, 6330.83308330833,
        6331.63316331633, 6332.43324332433, 6333.23332333233, 6334.03340334033,
        6334.83348334834, 6335.63356335634, 6336.43364336434, 6337.23372337234,
        6338.03380338034, 6338.83388338834, 6339.63396339634, 6340.43404340434,
        6341.23412341234, 6342.03420342034, 6342.83428342834, 6343.63436343634,
        6344.43444344435, 6345.23452345235, 6346.03460346035, 6346.83468346835,
        6347.63476347635, 6348.43484348435, 6349.23492349235, 6350.03500350035,
        6350.83508350835, 6351.63516351635, 6352.43524352435, 6353.23532353235,
        6354.03540354035, 6354.83548354836, 6355.63556355636, 6356.43564356436,
        6357.23572357236, 6358.03580358036, 6358.83588358836, 6359.63596359636,
        6360.43604360436, 6361.23612361236, 6362.03620362036, 6362.83628362836,
        6363.63636363636, 6364.43644364437, 6365.23652365237, 6366.03660366037,
        6366.83668366837, 6367.63676367637, 6368.43684368437, 6369.23692369237,
        6370.03700370037, 6370.83708370837, 6371.63716371637, 6372.43724372437,
        6373.23732373237, 6374.03740374037, 6374.83748374838, 6375.63756375638,
        6376.43764376438, 6377.23772377238, 6378.03780378038, 6378.83788378838,
        6379.63796379638
    };
    spectrum.intensities = {
        20.3344006841233, 21.0588171657296, 21.5828115349290, 20.8171963643481,
        20.1823063675625, 20.1696213951025, 20.4802977939384, 20.7486384954991,
        20.3872751834630, 20.1015250014893, 20.1935339056496, 20.2518549944181,
        19.5366386238750, 18.8173199567098, 18.6058613994100, 18.4226193861360,
        18.2531325802450, 17.8166546008719, 18.1642504297256, 18.6563176988540,
        18.4596878044590, 18.2729293243594, 18.3055624400339, 18.5365584777800,
        18.9760350212061, 19.2109777776261, 19.5085042083484, 19.8144144108574,
        19.8973394276018, 19.6786447094810, 20.1633912322003, 21.1166271260293,
        21.9301298095684, 22.6436074354091, 23.3213513925720, 24.2510332765913,
        25.4726078792161, 26.5145944162603, 27.5528138218955, 29.1540912991659,
        30.5139841615988, 31.4693365343406, 32.6652166569529, 33.8028282573440,
        34.7694590457589, 35.9079754567474, 36.7670818056010, 37.9336445885783,
        39.7370770447776, 40.8195748944075, 41.2816189031210, 42.3396467682319,
        44.1500998763315, 45.3149164798349, 45.6414168654222, 45.6860556242249,
        45.6834316809756, 46.5628017250029, 47.7109268577446, 48.0839047855738,
        48.7315985558913, 49.6634993535475, 49.8362903221566, 50.1398689989121,
        50.5324722215275, 50.2248616244976, 51.0288399521214, 52.7261913656787,
        53.5547473483310, 54.4103308663278, 55.2672963761933, 55.4684701214064,
        56.5415064782365, 58.2797624906001, 60.2537883552049, 61.7729162932542,
        62.8634856450936, 64.7970902803737, 66.0668112144320, 67.1037101705140,
        69.0252840808459, 71.2901292708136, 73.7554156454883, 75.5450498208570,
        77.5546642083586, 79.6790355630887, 82.0701568878921, 85.1612520565684,
        87.9806364950967, 90.5981711249564, 92.4138669281374, 94.8889139454804,
        96.9185199712878, 96.9260947237013, 98.4554791268687, 100.441602488557,
        101.569801530553, 102.332428113262, 102.820812381783, 102.671732783509,
        102.748066581176, 103.662482113754, 103.160546830665, 102.482317598264,
        102.038790194452, 99.6424822707785, 96.9540089826519, 95.4749977571873,
        93.5396871391585, 91.6366725130893, 89.8996031159385, 87.4126126830549,
        85.2438189765522, 83.3007598521458, 80.2149706384463, 76.4345787513747,
        73.4567771762743, 70.8502502225014, 68.0009985599941, 65.7418280414455,
        63.6990952708422, 60.4871521531586, 57.1537266702192, 54.8809010625157,
        53.3501120006218, 51.1213387918603, 48.2457833628902, 45.9530283632064,
        43.8827320253379, 41.4542567543366, 39.9457575025114, 39.2710445564653,
        38.0067931237937, 36.5099123700836, 35.6001978406603, 34.8814239222370,
        34.0287611332818, 33.2654054810930, 32.4734836515224, 31.6607353246533,
        31.4731459840343, 31.4915260661516, 30.9774461650852, 30.6679125954498,
        30.9012143158656, 31.1311111720398, 31.0272557185837, 30.5071414160780,
        30.4147771797268, 31.3612236713422, 31.6477297347542, 30.8735580908875,
        30.6432476126629, 30.8272612034104, 31.0982313886225, 30.9802180071911,
        30.4980016702723, 30.3384489872924, 30.2135051536670, 30.0944514877175,
        30.8538042614926, 31.7341774686734, 32.1603049792952, 31.6370408919847,
        30.9351382792334, 31.2890572911961, 31.3544049424696, 30.2762282564949,
        30.4748883361387, 31.2232651252866, 31.0096307119556, 30.3136229310571,
        30.5639472267946, 31.4751224616634, 31.4358848145889, 31.2721956134872,
        31.3509397195458, 31.8150712001185, 31.9568031799871, 32.1379241153866,
        32.7035786408356, 32.9656024005389, 33.9320795137384, 34.8559908231375,
        35.1967258596172, 35.7722344896517, 36.7195988216815, 37.2893717667256,
        37.9271042197275, 38.7524025185490, 38.6778994952221, 39.4567374275269,
        41.0326556086183, 42.4940241116641, 43.4967326009145, 44.3715522002357,
        45.0002913562085, 44.9806029236131, 45.1123391884715, 45.8873195046521,
        47.1362704247875, 47.5358112893573, 47.4796025548015, 48.3459699443253,
        49.3671458951011, 49.3844437300909, 49.1938111334924, 48.8271486527129,
        49.1028021251973, 49.3418882819253, 48.3678307829871, 48.2376757473677,
        48.2405303938310, 47.3278562308182, 46.9331611444327, 47.0196798339074,
        46.3237391977477, 45.6173879946512, 44.5985267508487, 43.5438627245355,
        43.4035350614118, 42.6139119093119, 41.7549172688620, 41.6707698149109,
        41.6783968840283, 40.8877750983608, 39.5161319036179, 38.6347470725634,
        38.2063846411236, 38.2198055845508, 37.7456441737049, 37.2527272436471,
        37.2062344071224, 36.4104550399395, 36.8964536301632, 37.8495644808220,
        37.0219899894578, 36.3898614161211, 36.3491914999339, 36.1452905352251,
        36.5521822995702, 37.0266392776874, 36.9752467636306, 37.0388802963625,
        37.0013118068152, 36.7611129409127, 37.2649311519279, 38.0663792202793,
        38.0852592313145, 37.9962165066185, 37.9250066696733, 37.2082640569922,
        36.7722491913932, 37.7506037131244, 38.7865746301191, 39.2918286382389,
        39.2743349969699, 39.0712536910568, 39.1934272250104, 39.2537556997656,
        39.3387667570597, 39.3011228935249, 39.1656335648484, 38.7141806375316,
        38.5648134766457, 39.0710090309450, 39.3983636829415, 39.2871535321904,
        38.3154537394815, 37.1767611408176, 36.6991494217365, 36.4765580855655,
        36.5666060554085, 36.5515505289011, 35.1986621876624, 33.8169620226584,
        34.1089090416457, 34.3923164516956, 33.5136307514652, 32.8401173930244,
        32.0997547796299, 30.9579225575410, 30.5891012528719, 30.3069698531793,
        29.5231098262811, 28.4710159877517, 27.5512503121316, 27.6715912860353,
        27.1180442241360, 25.9359600187799, 25.6019721639463, 24.8754776117837,
        23.6077918659203, 22.9749088377493, 22.4450007894336, 21.3617480729763,
        20.6337719580316, 20.1532457892242, 19.6376165914830, 18.8916427816640,
        17.7813415450792, 16.9404665941166, 16.7448046646816, 15.7591071496986,
        14.8350739716297, 14.3594598535822, 13.2608991474508, 12.5205485848703,
        12.1734187205410, 11.9999321254327, 11.3644668405857, 10.2839543832195,
        9.67506718886518, 9.15480723062486, 8.64613543076102, 8.39187943319594,
        7.95344700673485, 7.36543417187306, 7.00913394203559, 6.55171809970490,
        6.17215014963010
    };
    Splitters splitters = {
        { // left splitter
            { 6169.34168811206, 15.4047648488563, 1565.44047703928 },
            { 6202.91382404048, 12.1596678004392, 2019.27452305637 },
            { 6212.93742314091, 22.0358886758197, 2059.59589755202 },
        },
        { // right splitter
            { 6247.59342600529, 15.3144823790920, 1059.69215550574 },
            { 6288.12762828811, 16.4335471388011, 1891.37330019872 },
            { 6328.46106316910, 17.1151348022638, 1335.20625472714 },
        }
    };
    Indices clearPeakIndices = {0, 1};
    Indices peakIndices = {101, 208};
    constexpr DataType resolutionCoefficient = 0.00214166770575118;
    EmergencyCorrection(segmentIndex, spectrum, splitters, clearPeakIndices,
        peakIndices, resolutionCoefficient, options);

    Splitters correct = {
        {
            { 6168.07488874525, 14.7150059702196, 1456.44288880652 },
            { 6203.11510909419, 12.8540071209822, 2128.40150415927 },
            { 6208.68405293035, 20.4613878449525, 1863.53523663152 },
        },
        {
            { 6250.5516914056,  14.2510949444747, 827.524488199857 },
            { 6288.66271010904, 16.6866761959205, 1947.84757157891 },
            { 6329.26159481479, 16.5811758391505, 1279.9466864889 }
        },
    };

    for(Index i = 0; i < splitters.size(); i++)
    {
        for(Index j = 0; j < splitters[i].size(); j++)
        {
            EXPECT_NEAR(correct[i][j].mean, splitters[i][j].mean, MAX_ERROR);
            EXPECT_NEAR(correct[i][j].deviation, splitters[i][j].deviation, MAX_ERROR);
            EXPECT_NEAR(correct[i][j].weight, splitters[i][j].weight, MAX_ERROR);
        }
    }
}

TEST_F(EmergencyCorrectionTest, correctly_compues_model_intensities)
{
  
}

TEST_F(EmergencyCorrectionTest, correctly_scales_components)
{
}
}
